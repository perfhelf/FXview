# FXView 后续改造计划

## 📌 改造失败记录 (2026-01-15)

### 尝试的功能：拖拽排序 (Drag-and-Drop Reordering)
- **目标**：允许用户拖拽卡片/表格行来自定义货币显示顺序，并通过 `localStorage` 持久化。
- **使用的库**：`@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities`, `@dnd-kit/modifiers`

### ❌ 失败原因：重写 `page.tsx` 时破坏了原有功能

在实现拖拽功能的过程中，对 `page.tsx` 进行了大规模重写，导致以下核心功能丢失：

| 丢失的功能 | 原有行为 | 改造后行为 |
|-----------|---------|-----------|
| **每张卡片周期切换** | 每张信息卡上都有独立的周期切换按钮（1H/2H/4H/日/周/月） | 变成右上角统一的全局周期选择器 |
| **黑暗模式按钮** | 右上角有明显的主题切换按钮 | 按钮消失 |
| **TradingView 图表链接** | 每张卡片点击可跳转到对应公式的 TradingView 图表 | 未知状态 |

### 🔧 根本原因分析

1. **没有充分理解现有代码结构**
   - `page.tsx` 是一个 700+ 行的复杂组件，包含多个交互功能
   - 在添加拖拽逻辑时，直接在原文件上大规模修改，而不是增量添加

2. **缺乏测试验证**
   - 改造后只验证了"拖拽功能是否生效"
   - 没有系统性验证原有功能是否保留

3. **过于激进的重构**
   - 应该采用最小改动原则，仅在必要位置插入 `DndContext` 和 `SortableContext`
   - 实际上重写了整个渲染逻辑

### ✅ 正确的实现方式（待后续执行）

1. **备份原始文件**
   ```bash
   cp frontend/app/page.tsx frontend/app/page.tsx.backup
   ```

2. **增量添加拖拽**
   - 仅在 `CurrencyCard` 和 `TableRow` 组件外层包裹 `useSortable`
   - 保留所有原有的子组件和交互逻辑
   - 拖拽手柄应该是新增元素，而不是替换现有元素

3. **逐步验证**
   - 每添加一个功能点，立即在本地验证
   - 检查清单：
     - [ ] 卡片周期切换按钮存在且可用
     - [ ] 黑暗模式按钮存在且切换正常
     - [ ] TradingView 链接正常跳转
     - [ ] 趋势信号颜色显示正确
     - [ ] 表格视图切换正常
     - [ ] 拖拽功能正常
     - [ ] 顺序持久化到 localStorage

---

## 📋 未来改造待办

### 高优先级
- [ ] 修复当前问题（如果回滚后仍有问题）
- [ ] 重新实现拖拽排序（使用正确的增量方式）

### 中优先级
- [ ] 添加更多货币指数
- [ ] 优化移动端体验

### 低优先级
- [ ] 添加用户偏好设置面板
- [ ] 添加趋势通知功能

---

## 📚 相关文件
- 主前端文件：`frontend/app/page.tsx`
- 知识库：`知识库_KNOWLEDGE_BASE.md`
- 稳定版本 Git Commit：`76dba4a` (fix: switch XAU/XAG to futures)
